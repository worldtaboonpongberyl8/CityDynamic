<template>
	<template if:true={isLoading}>
		<lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
	</template>
	<div class="section-header slds-grid slds-justify-between slds-align-center slds-p-vertical_small slds-p-horizontal_medium slds-m-bottom_small">
		<div class="slds-col section-header-text">
			Opportunity To
		</div>
		<div class="slds-col slds-text-align_right">
			<template if:true={isShowAddButton}>
				<lightning-button
					label="Add"
					variant="neutral"
					onclick={handleAdd}>
				</lightning-button>
			</template>
		</div>
	</div>
	<template for:each={newOpportunities} for:item="item" for:index="index">
		<div key={item.key} class="slds-m-bottom_medium">
			<!-- Select Opportunity From -->
			<lightning-layout horizontal-align="spread">
				<!-- Left: Label -->
				<lightning-layout-item class="slds-text-title_bold slds-grid" style="min-width: auto;">
					<template if:true={isRemovable}>
						<div class="slds-col" style="padding-top: 3px;">
							<lightning-button-icon
								icon-name="utility:close"
								variant="bare"
								alternative-text="Remove"
								title="Remove"
								size="x-small"
								class="remove-icon-button slds-m-right_x-small"
								data-index={index}
								onclick={handleRemove}>
							</lightning-button-icon>
						</div>
					</template>
					<div class="slds-col">
						<label class="slds-form-element__label slds-truncate">Opportuntiy (To) </label>
					</div>
				</lightning-layout-item>
				<!-- Right: Record Picker -->
				<lightning-layout-item style="min-width: 350px;" class="custom-picker">
					<lightning-record-picker
						required
						label="New Opportunity"
						variant="label-hidden"
						placeholder="Select Opportunity"
						object-api-name="Opportunity"
						filter={opportunityFilter}
						matching-info={opportunityMatchingInfo}
						onchange={handleNewOppChange}
						data-index={index}
						data-id="newOppPicker">
					</lightning-record-picker>
				</lightning-layout-item>
			</lightning-layout>
			<template if:true={item.isShowDetail}>
				<div class={item.detailWrapperClass}>
					<!-- New Opportuntiy Detail -->
					<div class="slds-m-top_medium">
						<lightning-layout horizontal-align="spread" class="slds-m-bottom_small">
							<lightning-layout-item class="slds-text-title_bold">Project Name</lightning-layout-item>
							<lightning-layout-item class="slds-text-align_right">
								{item.newOppDetails.projectName}
							</lightning-layout-item>
						</lightning-layout>
						<lightning-layout horizontal-align="spread" class="slds-m-bottom_small">
							<lightning-layout-item class="slds-text-title_bold">Unit Name</lightning-layout-item>
							<lightning-layout-item class="slds-text-align_right">
								{item.newOppDetails.unitName}
							</lightning-layout-item>
						</lightning-layout>
						<lightning-layout horizontal-align="spread" class="slds-m-bottom_small">
							<!-- <template if:false={isMovePayment}> -->
								<lightning-layout-item class="slds-text-title_bold">Net Price</lightning-layout-item>
								<lightning-layout-item class="slds-text-align_right">
									<lightning-formatted-number
										value={item.newOppDetails.netPrice}
										minimum-fraction-digits="2"
										maximum-fraction-digits="2">
									</lightning-formatted-number>
								</lightning-layout-item>
							<!-- </template> -->
						</lightning-layout>
						<lightning-layout horizontal-align="spread" class="slds-m-bottom_small">
							<!-- <template if:true={isMovePayment}> -->
								<lightning-layout-item class="slds-text-title_bold">Total Paid Amount</lightning-layout-item>
								<lightning-layout-item class="slds-text-align_right">
									<lightning-formatted-number
										value={item.newOppDetails.totalPaidAmount}
										minimum-fraction-digits="2"
										maximum-fraction-digits="2">
									</lightning-formatted-number>
								</lightning-layout-item>
							<!-- </template> -->
						</lightning-layout>
						<template if:true={isMovePayment}>
							<lightning-layout horizontal-align="spread" class="slds-m-bottom_small">
								<lightning-layout-item class="slds-text-title_bold">Move Payment Amount</lightning-layout-item>
								<lightning-layout-item class="slds-text-align_right" style="min-width: 200px;">
									<div class="custom-input-wrapper">
										<lightning-input
											type="number"
											step="0.01"
											min="0"
											variant="label-hidden"
											class="number-input"
											value={item.amountToMove}
											data-index={index}
											data-id="moveAmountInput"
											onchange={handleMovePaymentAmountChange}>
										</lightning-input>
										<lightning-icon
											icon-name="utility:edit"
											size="xx-small"
											class="edit-icon">
										</lightning-icon>
									</div>
								</lightning-layout-item>
							</lightning-layout>
						</template>
					</div>
					<hr class="custom-hr slds-m-vertical_large" />
					<!-- New Opportunity Promotions -->
					<template if:true={item.newOppDetails.opportunityPromotions}>
						<div class="slds-m-top_medium">
							<div class="slds-text-title_bold slds-m-bottom_x-small">Opportunity Promotions</div>
							<template if:true={item.newOppDetails.hasOpportunityPromotion}>
								<ul class="slds-list_dotted">
									<template for:each={item.newOppDetails.opportunityPromotions} for:item="promo">
										<template if:true={promo.isReceived}>
											<li key={promo.id} class="slds-p-vertical_x-small green-bullets">
												{promo.name}
											</li>
										</template>
										<template if:false={promo.isReceived}>
											<li key={promo.id} class="slds-p-vertical_x-small">
												{promo.name}
											</li>
										</template>
									</template>
								</ul>
							</template>
							<template if:false={item.newOppDetails.hasOpportunityPromotion}>
								<div class="slds-align_absolute-center slds-m-around_medium">
									<span class="slds-text-color_weak" style="font-size: x-small;">No Promotion Available</span>
								</div>
							</template>
						</div>
					</template>
					<hr class="custom-hr slds-m-vertical_large" />
					<!-- New Client Offers -->
					<template if:true={item.newOppDetails.clientOffers}>
						<div class="slds-m-top_medium">
							<div class="slds-text-title_bold slds-m-bottom_x-small">Client Offers</div>
							<template if:true={item.newOppDetails.hasClientOffer}>
								<ul class="slds-list_dotted">
									<template for:each={item.newOppDetails.clientOffers} for:item="offer">
										<template if:true={offer.isReceived}>
											<li key={offer.id} class="slds-p-vertical_x-small green-bullets">
												{offer.name}
											</li>
										</template>
										<template if:false={offer.isReceived}>
											<li key={offer.id} class="slds-p-vertical_x-small">
												{offer.name}
											</li>
										</template>
									</template>
								</ul>
							</template>
							<template if:false={item.newOppDetails.hasClientOffer}>
								<div class="slds-align_absolute-center slds-m-around_medium">
									<span class="slds-text-color_weak" style="font-size: x-small;">No Client Offer Available</span>
								</div>
							</template>
						</div>
					</template>
					<hr class="custom-hr slds-m-vertical_large" />
				</div>
			</template>
		</div>
	</template>
	<hr class="slds-m-vertical_large bold-line"/>
	<div class="slds-m-top_medium">
		<div class="slds-text-title_bold slds-m-bottom_x-small">Promotion Summary</div>
		<template if:true={hasSelectedPromotions}>
			<ul class="slds-list_dotted">
				<template for:each={selectedPromotions} for:item="selectedPromotion">
					<li  key={selectedPromotion.id} class={selectedPromotion.animationClass} style={selectedPromotion.style}>
						<div class="slds-grid slds-p-vertical_x-small" >
							<!-- Left: Promotion name -->
							<div class="slds-col">
								{selectedPromotion.name}
							</div>
							<!-- Right: Combobox (only if action is move_payment) -->
							<template if:true={isMovePayment}>
								<div class="slds-col_bump-left slds-size_1-of-2">
									<lightning-layout >
										<!-- Label column (adjust width here) -->
										<lightning-layout-item flexibility="auto" class="slds-p-right_small slds-text-align_right" style="min-width: 120px;">
											<label class="slds-form-element__label">To Opportunity: </label>
										</lightning-layout-item>
										<!-- Combobox column -->
										<lightning-layout-item flexibility="grow" style="min-width: 200px; max-width: 200px;">
											<div class="custom-combobox custom-combobox-wrapper">
												<lightning-combobox
													variant="label-hidden"
													value={selectedPromotion.toOpportunityId}
													data-id={selectedPromotion.id}
													options={availableNewOpportunityOptions}
													onchange={handleToOppChange}>
												</lightning-combobox>
											</div>
										</lightning-layout-item>
									</lightning-layout>
								</div>
							</template>
						</div>
					</li>
				</template>
			</ul>
		</template>
		<template if:false={hasSelectedPromotions}>
			<div class="slds-align_absolute-center slds-m-around_medium">
				<span class="slds-text-color_weak" style="font-size: x-small;">No Selected Promotion Available</span>
			</div>
		</template>
	</div>
	<hr class="custom-hr slds-m-vertical_large"/>
	<!-- URL -->
	<div class="slds-m-top_small">
		<lightning-layout horizontal-align="spread">
			<lightning-layout-item class="slds-text-title_bold">{urlLabel}</lightning-layout-item>
			<lightning-layout-item class="slds-text-align_right" style="min-width: 350px;">
				<div class="custom-input-wrapper">
					<lightning-input
						required
						class="url-input with-icon"
						variant="label-hidden"
						type="text"
						label="URL"
						value={urlDoc}
						data-id="urlInput"
						onchange={handleURLChange}
						onblur={validateURL}>
					</lightning-input>
					<lightning-icon
						icon-name="utility:edit"
						size="xx-small"
						class="edit-icon">
					</lightning-icon>
				</div>
			</lightning-layout-item>
		</lightning-layout>
	</div>
</template>